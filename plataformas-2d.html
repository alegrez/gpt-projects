<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Juego de Plataformas con Menú</title>
    <style>
        body {
            margin: 0;
            background-color: #1a202c;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: #e2e8f0;
            text-align: center;
            overflow: hidden; /* Evita el scroll en móviles */
        }
        .game-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        canvas {
            background-color: #2d3748;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background-color 0.1s linear;
        }
        .instructions {
            background-color: #2d3748;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .instructions h1 {
            margin: 0 0 0.5rem 0;
            color: #63b3ed;
            font-size: 1.5rem;
        }
        .instructions p {
            margin: 0;
            font-size: 0.9rem;
            color: #a0aec0;
        }
        .instructions kbd {
            background-color: #4a5568;
            color: #e2e8f0;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
        }
        /* Estilos para Controles Móviles */
        #mobile-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* Ocultos por defecto */
            justify-content: space-between;
            align-items: flex-end;
            padding: 20px;
            box-sizing: border-box;
            pointer-events: none; /* Permite clics al canvas */
        }
        .control-cluster {
            display: flex;
            gap: 20px;
            pointer-events: all; /* Habilita clics en los botones */
        }
        .control-cluster button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none; /* Evita selección de texto */
            -webkit-user-select: none;
        }
        #jump-btn {
             width: 80px;
             height: 80px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        <div class="instructions">
            <h1 id="title">Menú Principal</h1>
            <p id="controls">Usa <kbd>&larr;</kbd> <kbd>&rarr;</kbd> y <kbd>Espacio</kbd> para jugar. Presiona <kbd>Esc</kbd> para salir. <br>¡Mantén <kbd>Espacio</kbd> al rebotar en paredes verdes para un salto de pared!</p>
        </div>
        <!-- Controles Móviles -->
        <div id="mobile-controls">
            <div class="control-cluster">
                <button id="left-btn">&larr;</button>
                <button id="right-btn">&rarr;</button>
            </div>
             <div class="control-cluster">
                <button id="jump-btn-left">↑</button>
            </div>
            <div class="control-cluster">
                <button id="jump-btn-right">↑</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const titleElement = document.getElementById('title');

        // --- CONFIGURACIÓN INICIAL ---
        const aspectRatio = 16 / 9;
        const canvasWidth = Math.min(window.innerWidth * 0.9, 800);
        canvas.width = canvasWidth;
        canvas.height = canvasWidth / aspectRatio;

        // --- ESTADOS DEL JUEGO ---
        let gameState = 'MENU'; // 'MENU', 'PLAYING', 'CELEBRATING'
        let currentLevel = null;
        let celebrationInfo = { startTime: 0, hue: 0 };

        // --- OBJETOS DEL JUEGO ---
        const player = {
            x: 100, y: canvas.height - 100,
            originalWidth: 30, originalHeight: 30,
            width: 30, height: 30,
            color: '#63b3ed',
            velocityX: 0, velocityY: 0,
            isJumping: false,
            canDoubleJump: false,
            hasDoubleJumped: false
        };

        const physics = {
            gravity: 0.5,
            jumpForce: -12,
            maxSpeed: 20,
            acceleration: 0.5,
            friction: 0.9,
            bounceHorizontalDampening: 0.7, 
            bounceVerticalDampening: 0.5,
            wallJumpBoost: 11
        };

        const keys = { right: false, left: false, space: false, spaceJustPressed: false };
        const camera = { x: 0, y: 0, zoom: 1, lerpFactor: 0.05 };

        // --- DATOS DE NIVELES ---
        let currentLevelData = {};
        let currentPlatforms = [];
        let currentBouncyWalls = [];
        let currentPowerUps = [];
        let currentHazards = [];
        let endGoal = {};

        const level1Data = {
            platforms: [ { x: 0, y: canvas.height - 40, width: 600, height: 40 }, { x: 700, y: canvas.height - 100, width: 200, height: 20 }, { x: 1000, y: canvas.height - 180, width: 150, height: 20 }, { x: 1250, y: canvas.height - 280, width: 150, height: 20 }, { x: 1500, y: canvas.height - 220, width: 100, height: 20 }, { x: 1700, y: canvas.height - 150, width: 250, height: 20 }, { x: 2100, y: canvas.height - 250, width: 80, height: 20 }, { x: 2300, y: canvas.height - 350, width: 80, height: 20 }, { x: 2500, y: canvas.height - 450, width: 80, height: 20 }, { x: 2700, y: canvas.height - 40, width: 1000, height: 40 } ],
            bouncyWalls: [],
            powerUps: [],
            hazards: [],
            goal: { x: 3650, y: canvas.height - 80, width: 50, height: 40 },
            cameraFollowsDown: false
        };
        const level2Data = {
            platforms: [ { x: canvas.width / 2 - 150, y: canvas.height - 40, width: 300, height: 40 }, { x: canvas.width / 2 + 50, y: canvas.height - 140, width: 150, height: 20 }, { x: canvas.width / 2 - 200, y: canvas.height - 240, width: 150, height: 20 }, { x: canvas.width / 2 - 50, y: canvas.height - 340, width: 180, height: 20 }, { x: canvas.width - 200, y: canvas.height - 440, width: 200, height: 20 }, { x: canvas.width / 2 - 100, y: canvas.height - 540, width: 100, height: 20 }, { x: 100, y: canvas.height - 640, width: 150, height: 20 }, { x: 300, y: canvas.height - 760, width: 200, height: 20 }, { x: canvas.width - 250, y: canvas.height - 860, width: 80, height: 20 }, { x: canvas.width/2 - 40, y: canvas.height - 960, width: 80, height: 20 }, { x: 150, y: canvas.height - 1060, width: 150, height: 20 }, { x: 400, y: canvas.height - 1160, width: 150, height: 20 }, { x: canvas.width/2 - 100, y: canvas.height - 1260, width: 200, height: 20 }, ],
            bouncyWalls: [],
            powerUps: [],
            hazards: [],
            goal: { x: canvas.width / 2 - 25, y: canvas.height - 1320, width: 50, height: 60 },
            cameraFollowsDown: false
        };
        const level3Data = {
            platforms: [
                { x: canvas.width / 2 - 100, y: canvas.height - 40, width: 200, height: 40 },
                { x: 120, y: canvas.height - 220, width: 230, height: 20 },
                { x: canvas.width / 2, y: canvas.height - 420, width: 130, height: 20 },
                { x: canvas.width / 2 + 100, y: canvas.height - 520, width: 130, height: 20 },
                { x: 120, y: canvas.height - 620, width: 130, height: 20 },
                { x: 120, y: canvas.height - 820, width: 50, height: 20 },
                { x: 120, y: canvas.height - 1020, width: 50, height: 20 },
                { x: canvas.width / 2 - 75, y: canvas.height - 1100, width: 150, height: 20 },
            ],
            bouncyWalls: [
                { x: canvas.width - 120, y: canvas.height - 250, width: 20, height: 200 },
                { x: 80, y: canvas.height - 450, width: 20, height: 200 },
                { x: 100, y: canvas.height - 1100, width: 20, height: 500 }
            ],
            powerUps: [],
            hazards: [],
            goal: { x: canvas.width / 2 - 25, y: canvas.height - 1140, width: 50, height: 40 },
            cameraFollowsDown: true
        };
        const level4Data = {
            platforms: [
                { x: 0, y: canvas.height - 40, width: 300, height: 40 },
                { x: 500, y: canvas.height - 40, width: 400, height: 40 },
                { x: 1100, y: canvas.height - 120, width: 200, height: 20 },
                { x: 1500, y: canvas.height - 40, width: 400, height: 40 },
                { x: 2200, y: canvas.height - 40, width: 200, height: 40 },
                { x: 2600, y: canvas.height - 150, width: 150, height: 20 },
                { x: 3000, y: canvas.height - 40, width: 500, height: 40 },
            ],
            bouncyWalls: [],
            powerUps: [
                { x: 200, y: canvas.height - 80, width: 25, height: 25, isActive: true, respawnTime: 0 },
                { x: 1700, y: canvas.height - 80, width: 25, height: 25, isActive: true, respawnTime: 0 },
                { x: 2300, y: canvas.height - 200, width: 25, height: 25, isActive: true, respawnTime: 0 },
            ],
            hazards: [
                { x: 350, y: canvas.height - 60, width: 100, height: 20 },
                { x: 950, y: canvas.height - 60, width: 100, height: 20 },
                { x: 1950, y: canvas.height - 60, width: 200, height: 20 },
                { x: 2800, y: canvas.height - 60, width: 150, height: 20 }
            ],
            goal: { x: 3400, y: canvas.height - 80, width: 50, height: 40 },
            cameraFollowsDown: false
        };


        // --- MENÚ ---
        const menuButtons = [
            { x: canvas.width / 2 - 150, y: canvas.height / 2 - 110, width: 300, height: 50, text: 'Nivel 1: Horizontal', level: 1 },
            { x: canvas.width / 2 - 150, y: canvas.height / 2 - 50, width: 300, height: 50, text: 'Nivel 2: Vertical', level: 2 },
            { x: canvas.width / 2 - 150, y: canvas.height / 2 + 10, width: 300, height: 50, text: 'Nivel 3: Torre de Rebote', level: 3 },
            { x: canvas.width / 2 - 150, y: canvas.height / 2 + 70, width: 300, height: 50, text: 'Nivel 4: Doble Salto', level: 4 }
        ];

        // --- MANEJO DE ENTRADAS ---
        function setupMobileControls() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            if (!isMobile) return;

            // Forzar orientación horizontal
            try {
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(err => console.log("No se pudo bloquear la orientación:", err));
                }
            } catch (error) {
                console.log("API de orientación de pantalla no soportada:", error);
            }

            document.getElementById('mobile-controls').style.display = 'flex';
            document.getElementById('controls').innerHTML = 'Usa los botones en pantalla para jugar.';

            const leftBtn = document.getElementById('left-btn');
            const rightBtn = document.getElementById('right-btn');
            const jumpBtnLeft = document.getElementById('jump-btn-left');
            const jumpBtnRight = document.getElementById('jump-btn-right');

            const handleJumpPress = (e) => {
                e.preventDefault();
                if (!keys.space) {
                    keys.spaceJustPressed = true;
                }
                keys.space = true;
            };

            const handleJumpRelease = (e) => {
                e.preventDefault();
                keys.space = false;
            };

            leftBtn.addEventListener('touchstart', (e) => { e.preventDefault(); keys.left = true; });
            leftBtn.addEventListener('touchend', (e) => { e.preventDefault(); keys.left = false; });

            rightBtn.addEventListener('touchstart', (e) => { e.preventDefault(); keys.right = true; });
            rightBtn.addEventListener('touchend', (e) => { e.preventDefault(); keys.right = false; });

            jumpBtnLeft.addEventListener('touchstart', handleJumpPress);
            jumpBtnLeft.addEventListener('touchend', handleJumpRelease);
            jumpBtnRight.addEventListener('touchstart', handleJumpPress);
            jumpBtnRight.addEventListener('touchend', handleJumpRelease);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && gameState === 'PLAYING') goToMenu();
            if (gameState !== 'PLAYING' && gameState !== 'MENU') return;
            if (e.code === 'ArrowRight') keys.right = true;
            if (e.code === 'ArrowLeft') keys.left = true;
            if (e.code === 'Space') {
                if (!keys.space) {
                    keys.spaceJustPressed = true;
                }
                keys.space = true;
            }
        });
        document.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowRight') keys.right = false;
            if (e.code === 'ArrowLeft') keys.left = false;
            if (e.code === 'Space') keys.space = false;
        });
        canvas.addEventListener('mousedown', (e) => {
            if (gameState !== 'MENU') return;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            menuButtons.forEach(button => {
                if (mouseX > button.x && mouseX < button.x + button.width && mouseY > button.y && mouseY < button.y + button.height) {
                    startGame(button.level);
                }
            });
        });

        // --- FUNCIONES DEL JUEGO ---
        function goToMenu() {
            gameState = 'MENU';
            titleElement.textContent = 'Menú Principal';
            camera.zoom = 1;
            canvas.style.backgroundColor = '#2d3748';
        }
        
        function startGame(level) {
            currentLevel = level;
            if (level === 1) currentLevelData = level1Data;
            else if (level === 2) currentLevelData = level2Data;
            else if (level === 3) currentLevelData = level3Data;
            else if (level === 4) currentLevelData = level4Data;
            
            currentPlatforms = currentLevelData.platforms;
            currentBouncyWalls = currentLevelData.bouncyWalls;
            currentPowerUps = currentLevelData.powerUps.map(p => ({...p}));
            currentHazards = currentLevelData.hazards;
            endGoal = currentLevelData.goal;
            titleElement.textContent = `Nivel ${level}`;
            resetPlayer(level);
            gameState = 'PLAYING';
        }

        function resetPlayer(level) {
            if (level === 3 || level === 4) {
                 player.x = canvas.width / 2 - player.originalWidth / 2;
                 player.y = canvas.height - 100;
            } else {
                 player.x = canvas.width / 2;
                 player.y = canvas.height - 100;
            }
            if (level === 1 || level === 4) {
                player.x = 100;
                camera.x = 0;
                camera.y = 0;
            } else {
                 camera.x = 0;
                 camera.y = 0;
            }
            player.velocityX = 0;
            player.velocityY = 0;
            player.isJumping = false;
            player.canDoubleJump = false;
            player.hasDoubleJumped = false;
            player.width = player.originalWidth;
            player.height = player.originalHeight;
        }

        function updatePlayerAppearance(landedThisFrame) {
            const LERP_FACTOR = 0.15;
            let targetWidth = player.originalWidth;
            let targetHeight = player.originalHeight;
            const oldHeight = player.height;
            if (landedThisFrame) {
                targetWidth = player.originalWidth * 1.4;
                targetHeight = player.originalHeight * 0.7;
            } else if (player.isJumping) {
                if (player.velocityY < -1) {
                    targetWidth = player.originalWidth * 0.8;
                    targetHeight = player.originalHeight * 1.2;
                } else if (player.velocityY > 1) {
                    targetWidth = player.originalWidth * 0.8;
                    targetHeight = player.originalHeight * 1.2;
                } else {
                    targetWidth = player.originalWidth * 1.2;
                    targetHeight = player.originalHeight * 0.8;
                }
            }
            player.width += (targetWidth - player.width) * LERP_FACTOR;
            player.height += (targetHeight - player.height) * LERP_FACTOR;
            if (!player.isJumping) {
                player.y += oldHeight - player.height;
            }
        }

        function updateGame() {
            if (!player.isJumping) {
                if (keys.right) player.velocityX += physics.acceleration;
                else if (keys.left) player.velocityX -= physics.acceleration;
                else player.velocityX *= physics.friction;
                if (Math.abs(player.velocityX) < 0.1) player.velocityX = 0;
                
                if (keys.space) {
                    player.isJumping = true;
                    player.velocityY = physics.jumpForce;
                    player.hasDoubleJumped = false;
                }
            } else { 
                 if (keys.spaceJustPressed && player.canDoubleJump && !player.hasDoubleJumped) {
                    player.velocityY = physics.jumpForce;
                    player.hasDoubleJumped = true;
                    player.canDoubleJump = false;
                }
            }

            if (player.velocityX > physics.maxSpeed) player.velocityX = physics.maxSpeed;
            if (player.velocityX < -physics.maxSpeed) player.velocityX = -physics.maxSpeed;
            
            player.velocityY += physics.gravity;
            const prevX = player.x;
            player.x += player.velocityX;
            player.y += player.velocityY;

            for (const hazard of currentHazards) {
                if (player.x < hazard.x + hazard.width && player.x + player.width > hazard.x &&
                    player.y < hazard.y + hazard.height && player.y + player.height > hazard.y) {
                    resetPlayer(currentLevel);
                    return;
                }
            }

            currentPowerUps.forEach(powerup => {
                if (powerup.isActive && player.x < powerup.x + powerup.width && player.x + player.width > powerup.x &&
                    player.y < powerup.y + powerup.height && player.y + player.height > powerup.y) {
                    player.canDoubleJump = true;
                    powerup.isActive = false;
                    powerup.respawnTime = Date.now() + 5000;
                }
                if (!powerup.isActive && Date.now() > powerup.respawnTime) {
                    powerup.isActive = true;
                }
            });

            currentBouncyWalls.forEach(wall => {
                if (player.x < wall.x + wall.width && player.x + player.width > wall.x &&
                    player.y < wall.y + wall.height && player.y + player.height > wall.y) {
                    const hitFromLeft = prevX + player.width <= wall.x && player.velocityX > 0;
                    const hitFromRight = prevX >= wall.x + wall.width && player.velocityX < 0;
                    if (hitFromLeft || hitFromRight) {
                        player.velocityX *= -physics.bounceHorizontalDampening;
                        player.x = hitFromLeft ? wall.x - player.width : wall.x + wall.width;
                        if (player.isJumping && keys.space) {
                            player.velocityY = -physics.wallJumpBoost;
                        } else if (player.isJumping) {
                             player.velocityY *= physics.bounceVerticalDampening;
                        } else {
                             player.velocityX = 0;
                        }
                    }
                }
            });

            let onPlatform = false;
            let justLanded = false;
            [...currentPlatforms, endGoal].forEach(platform => {
                if (player.velocityY >= 0 &&
                    player.y + player.height > platform.y &&
                    player.y + player.height < platform.y + 20 &&
                    player.x + player.width > platform.x &&
                    player.x < platform.x + platform.width) {
                    if (player.isJumping) justLanded = true;
                    if (platform === endGoal) {
                        gameState = 'CELEBRATING';
                        celebrationInfo.startTime = Date.now();
                        player.velocityX = 0;
                    }
                    player.y = platform.y - player.height;
                    player.velocityY = 0;
                    player.isJumping = false;
                    onPlatform = true;
                }
            });
            if (!onPlatform) player.isJumping = true;
            updatePlayerAppearance(justLanded);

            if (currentLevel === 1 || currentLevel === 4) {
                if (player.x < camera.x) player.x = camera.x;
                const targetCameraX = player.x - canvas.width / 3;
                if (targetCameraX > camera.x) camera.x += (targetCameraX - camera.x) * camera.lerpFactor;
                 if (player.y > camera.y + canvas.height + 200) resetPlayer(currentLevel);
            } else if (currentLevel === 2 || currentLevel === 3) {
                 if (player.x + player.width < 0) player.x = canvas.width;
                 if (player.x > canvas.width) player.x = -player.width;
                const targetCameraY = player.y - canvas.height / 1.5;
                if (currentLevelData.cameraFollowsDown) {
                    camera.y += (targetCameraY - camera.y) * camera.lerpFactor;
                    if (player.y > camera.y + canvas.height + 200) resetPlayer(currentLevel);
                } else {
                    if (targetCameraY < camera.y) {
                        camera.y += (targetCameraY - camera.y) * camera.lerpFactor;
                    }
                    if (player.y > camera.y + canvas.height) {
                        resetPlayer(currentLevel);
                    }
                }
            }

            keys.spaceJustPressed = false;
        }
        
        function updateCelebration() {
            if (Date.now() - celebrationInfo.startTime > 5000) {
                goToMenu();
                return;
            }
            celebrationInfo.hue = (celebrationInfo.hue + 1) % 360;
            camera.zoom = 1 + Math.sin((Date.now() - celebrationInfo.startTime) * 0.004) * 0.08;
            if (!player.isJumping) {
                player.velocityY = physics.jumpForce * 1.1;
                player.isJumping = true;
            }
            player.velocityY += physics.gravity;
            player.y += player.velocityY;
            if (player.velocityY >= 0 && player.y + player.height > endGoal.y) {
                player.y = endGoal.y - player.height;
                player.velocityY = 0;
                player.isJumping = false;
            }
        }

        // --- FUNCIONES DE DIBUJO ---
        function drawMenu() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = 'bold 24px sans-serif';
            ctx.fillStyle = '#e2e8f0';
            ctx.textAlign = 'center';
            menuButtons.forEach(button => {
                ctx.fillStyle = '#4a5568';
                ctx.fillRect(button.x, button.y, button.width, button.height);
                ctx.fillStyle = '#e2e8f0';
                ctx.fillText(button.text, button.x + button.width / 2, button.y + 32);
            });
        }

        function drawGame() {
            const isCelebrating = gameState === 'CELEBRATING';
            const hue = celebrationInfo.hue;
            const bgColor = isCelebrating ? `hsl(${hue}, 50%, 15%)` : '#2d3748';
            let playerColor = isCelebrating ? `hsl(${(hue + 120) % 360}, 80%, 70%)` : player.color;
            if (player.canDoubleJump && !isCelebrating) {
                playerColor = '#a78bfa';
            }
            const platformColor = isCelebrating ? `hsl(${hue}, 40%, 60%)` : '#a0aec0';
            const bouncyColor = isCelebrating ? `hsl(${(hue + 180) % 360}, 60%, 60%)` : '#48bb78';
            const powerUpColor = '#9f7aea';
            const hazardColor = isCelebrating ? `hsl(${(hue + 300) % 360}, 90%, 60%)` : '#ef4444';
            const goalColor = isCelebrating ? `hsl(${(hue + 60) % 360}, 90%, 60%)` : '#ffd700';

            canvas.style.backgroundColor = bgColor;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            
            const playerCenterX = player.x + player.width / 2;
            const playerCenterY = player.y + player.height / 2;
            ctx.translate(playerCenterX - camera.x, playerCenterY - camera.y);
            ctx.scale(camera.zoom, camera.zoom);
            ctx.translate(-(playerCenterX - camera.x), -(playerCenterY - camera.y));
            ctx.translate(-camera.x, -camera.y);

            const drawX = player.x - (player.width - player.originalWidth) / 2;
            ctx.fillStyle = playerColor;
            ctx.fillRect(drawX, player.y, player.width, player.height);

            ctx.fillStyle = platformColor;
            currentPlatforms.forEach(p => ctx.fillRect(p.x, p.y, p.width, p.height));

            ctx.fillStyle = bouncyColor;
            currentBouncyWalls.forEach(w => ctx.fillRect(w.x, w.y, w.width, w.height));

            ctx.fillStyle = hazardColor;
            currentHazards.forEach(h => ctx.fillRect(h.x, h.y, h.width, h.height));

            ctx.fillStyle = powerUpColor;
            currentPowerUps.forEach(p => {
                if (p.isActive) ctx.fillRect(p.x, p.y, p.width, p.height);
            });
            
            ctx.fillStyle = goalColor;
            ctx.fillRect(endGoal.x, endGoal.y, endGoal.width, endGoal.height);
            
            ctx.restore();
        }

        // --- BUCLE PRINCIPAL DEL JUEGO ---
        function gameLoop() {
            if (gameState === 'MENU') {
                drawMenu();
            } else if (gameState === 'PLAYING') {
                updateGame();
                drawGame();
            } else if (gameState === 'CELEBRATING') {
                updateCelebration();
                drawGame();
            }
            keys.spaceJustPressed = false;
            requestAnimationFrame(gameLoop);
        }

        // Iniciar todo
        setupMobileControls();
        gameLoop();
    </script>
</body>
</html>
